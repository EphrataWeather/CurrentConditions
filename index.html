    
    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Weather Viewer</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .controls {
            position: absolute; top: 20px; left: 20px; width: 280px;
            background: rgba(30, 30, 30, 0.9); color: white;
            padding: 20px; border-radius: 12px; z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        select { 
            width: 100%; padding: 10px; margin-top: 10px; 
            background: #444; color: white; border: none; border-radius: 5px; 
        }
        .instruction { font-size: 11px; color: #aaa; margin-top: 10px; }
        .mapboxgl-popup-content { color: #222; font-weight: bold; padding: 15px; }
    </style>
</head>
<body>

<div class="controls">
    <h3 style="margin:0">Weather Layers</h3>
    <select id="layer-picker" onchange="updateWeatherLayer(this.value)">
        <option value="rainviewer">Live Rain Radar (RainViewer)</option>
        <option value="temp_new">Temperature (OWM)</option>
        <option value="wind_new">Wind Speed (OWM)</option>
        <option value="clouds_new">Cloud Cover (OWM)</option>
        <option value="pressure_new">Pressure (OWM)</option>
    </select>
    <p class="instruction">Double-click / Double-tap any area to get exact weather values.</p>
</div>

<div id="map"></div>

<script>

    const MAPBOX_TOKEN = 'pk.eyJ1IjoiZ3RnMDExNiIsImEiOiJjbWxsODV6NXAwNThmM2ZwdWlkYm0xNjFlIn0.vI186twXYzY45nnuV5FucQ';
    const OWM_KEY = '5906af06cdd57431ce881975e794e337';
    
    mapboxgl.accessToken = MAPBOX_TOKEN;

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [-98, 38],
        zoom: 4,
        doubleClickZoom: false // Disabled so we can use dblclick for data
    });

    let currentLayerId = 'rainviewer';

    map.on('load', async () => {
        // 1. FIND THE TOP-MOST LABEL LAYER TO KEEP DATA BENEATH IT
        const layers = map.getStyle().layers;
        let firstLabelId;
        for (const layer of layers) {
            if (layer.type === 'symbol' || layer.id.includes('boundary') || layer.id.includes('label')) {
                firstLabelId = layer.id;
                break;
            }
        }

        // 2. GET RAINVIEWER LATEST DATA
        const rvResponse = await fetch('https://api.rainviewer.com/public/weather-maps.json');
        const rvData = await rvResponse.json();
        const latestRadar = rvData.radar.past[rvData.radar.past.length - 1].path;

        // 3. ADD SOURCES
        map.addSource('weather-source', {
            'type': 'raster',
            'tiles': [`https://tile.rainviewer.com${latestRadar}/256/{z}/{x}/{y}/2/1_1.png`],
            'tileSize': 256
        });

        // 4. ADD LAYER BENEATH LABELS
        map.addLayer({
            'id': 'weather-layer',
            'type': 'raster',
            'source': 'weather-source',
            'paint': { 'raster-opacity': 0.9 } // High opacity as requested
        }, firstLabelId);
    });

    async function updateWeatherLayer(val) {
        let newUrl;
        if (val === 'rainviewer') {
            const rvResponse = await fetch('https://api.rainviewer.com/public/weather-maps.json');
            const rvData = await rvResponse.json();
            const latestRadar = rvData.radar.past[rvData.radar.past.length - 1].path;
            newUrl = `https://tile.rainviewer.com${latestRadar}/256/{z}/{x}/{y}/2/1_1.png`;
        } else {
            newUrl = `https://tile.openweathermap.org/map/${val}/{z}/{x}/{y}.png?appid=${OWM_KEY}`;
        }
        
        map.getSource('weather-source').setTiles([newUrl]);
    }

    // 5. DOUBLE CLICK PICKER
    map.on('dblclick', async (e) => {
        const { lng, lat } = e.lngLat;
        
        // Show a temporary "Loading..." popup
        const popup = new mapboxgl.Popup()
            .setLngLat([lng, lat])
            .setHTML("Fetching data...")
            .addTo(map);

        try {
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=imperial&appid=${OWM_KEY}`;
            const res = await fetch(url);
            const data = await res.json();

            const content = `
                <div style="font-size:14px">
                    <strong style="font-size:16px">${data.name || 'Current Area'}</strong><br>
                    üå°Ô∏è Temp: ${Math.round(data.main.temp)}¬∞F<br>
                    üíß Humidity: ${data.main.humidity}%<br>
                    üå¨Ô∏è Wind: ${Math.round(data.wind.speed)} mph<br>
                    ‚òÅÔ∏è Clouds: ${data.clouds.all}%
                </div>
            `;
            popup.setHTML(content);
        } catch (err) {
            popup.setHTML("Error loading data.");
        }
    });

</script>
</body>
</html>
